<!DOCTYPE html>
<html>

<title>
	Merge Queue Simulator
</title>

<head>
	<link rel="stylesheet" href="style.css" />
<!--
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script src="game.js" ></script>
-->
</head>

<body style="background-color:#FFF">
    <div class="formframe">
        <form>
            <h2>Generate Input</h2>
            <label for="numPRs">Number of PRs:</label>
            <input type="number" id="numPRs" name="numPRs" value="1000" /><br/><br/>

            <label for="prsPerHour">PRs per Hour:</label>
            <input type="number" id="prsPerHour" name="prsPerHour" value="10"/><br/><br/>

            <label for="buildSpeedFast">Build Speed (Fast):</label>
            <input type="number" id="buildSpeedFast" name="buildSpeedFast" value="10" /></input><br/><br/>

            <label for="buildSuccessRateFast">Build Success Rate (Fast):</label>
            <input type="number" id="buildSuccessRateFast" name="buildSuccessRateFast" min="0" max="100" step="0.1" value="99" />%<br/><br/>

            <label for="buildSpeedVarianceFast">Build Speed Variance (Fast):</label>
            <input type="number" id="buildSpeedVarianceFast" name="buildSpeedVarianceFast" value="5" /><br/><br/>

            <label for="buildSpeedFull">Build Speed (Full):</label>
            <input type="number" id="buildSpeedFull" name="buildSpeedFull" value="25" /><br/><br/>

            <label for="buildSuccessRateFull">Build Success Rate (Full):</label>
            <input type="number" id="buildSuccessRateFull" name="buildSuccessRateFull" min="0" max="100" step="0.1" value="95" />%<br/><br/>

            <label for="buildSpeedVarianceFull">Build Speed Variance (Full):</label>
            <input type="number" id="buildSpeedVarianceFull" name="buildSpeedVarianceFull" value="10" /><br/><br/>

            <button type="button" id="generateBtn">Generate</button>
        </form>
    </div>

    <div class="formframe">
        <label for="inputData">Input Data:</label>
        <button type="button" id="copyBtn" onclick="copyToClipboard('inputData')">Copy to Clipboard</button><br/><br/>
        <textarea id="inputData" name="inputData" rows="10" cols="50"></textarea>
    </div>

    <div class="formframe">
        <form>
            <h2>Merge Queue Settings</h2>
            <label for="strategy">Strategy:</label>
            <select id="strategy" name="strategy">
                <option value="simple">Simple</option>
            </select><br/><br/>

            <label for="maxBatchSize">Maximum batch size:</label>
            <input type="number" id="maxBatchSize" name="maxBatchSize"><br/><br/>

            <button type="button" id="simulateBtn">Simulate queue</button>
        </form>
    </div>

    <div class="formframe">
        <label for="outputData">Output Data:</label>
        <button type="button" id="copyOutputBtn" onclick="copyToClipboard('outputData')">Copy to Clipboard</button><br/><br/>
        <textarea id="outputData" name="outputData" rows="10" cols="50"></textarea>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(element.value)
                .catch(err => {
                    console.error('Failed to copy: ', err);
                });
        }

        function generatePullRequests() {
            // Get form values
            const numPRs = parseInt(document.getElementById('numPRs').value) || 0;
            const prsPerHour = parseInt(document.getElementById('prsPerHour').value) || 1;
            const buildSpeedFast = parseInt(document.getElementById('buildSpeedFast').value) || 0;
            const buildSuccessRateFast = parseFloat(document.getElementById('buildSuccessRateFast').value) || 0;
            const buildSpeedVarianceFast = parseInt(document.getElementById('buildSpeedVarianceFast').value) || 0;
            const buildSpeedFull = parseInt(document.getElementById('buildSpeedFull').value) || 0;
            const buildSuccessRateFull = parseFloat(document.getElementById('buildSuccessRateFull').value) || 0;
            const buildSpeedVarianceFull = parseInt(document.getElementById('buildSpeedVarianceFull').value) || 0;

            // Generate pull requests
            const pullRequests = [];
            const secondsBetweenPRs = 3600 / prsPerHour;
            let cumulativeTime = 0;

            for (let i = 0; i < numPRs; i++) {
                // Add variance to the time between PRs using exponential distribution
                // This creates realistic bursts while maintaining the expected rate
                const randomFactor = -Math.log(1 - Math.random());
                const timeSinceLastPR = secondsBetweenPRs * randomFactor;
                cumulativeTime += timeSinceLastPR;

                // Calculate queue time with variance (in seconds)
                const queuetime = Math.round(cumulativeTime);

                // Determine if fast build passes (based on success rate)
                const FastBuildPasses = Math.random() * 100 < buildSuccessRateFast;

                // Determine if full build passes (based on success rate)
                const FullBuildPasses = FastBuildPasses && (Math.random() * 100 < buildSuccessRateFull);

                // Generate fast build time with variance (in seconds)
                const fastVariance = (Math.random() - 0.5) * 2 * buildSpeedVarianceFast;
                const FastBuildTime = Math.max(1, Math.round(buildSpeedFast + fastVariance));

                // Generate full build time with variance (in seconds)
                const fullVariance = (Math.random() - 0.5) * 2 * buildSpeedVarianceFull;
                const FullBuildTime = Math.max(1, Math.round(buildSpeedFull + fullVariance));

                pullRequests.push({
                    queuetime: queuetime,
                    FastBuildPasses: FastBuildPasses,
                    FullBuildPasses: FullBuildPasses,
                    FastBuildTime: FastBuildTime,
                    FullBuildTime: FullBuildTime
                });
            }

            // Populate the input data textarea with JSON
            document.getElementById('inputData').value = JSON.stringify(pullRequests, null, 2);
        }

        // Add event listener to generate button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('generateBtn').addEventListener('click', generatePullRequests);
        });
    </script>
</body>

</html>